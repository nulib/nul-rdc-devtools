#!/bin/bash

mkdir -p $HOME/.run

start() {
  if [[ -e $HOME/.run/es-proxy.cid ]]; then
    echo "es-proxy already running"
  else
    cid=$(docker run --rm -d -v $(dirname $0)/../helpers/es-proxy.conf:/etc/nginx/conf.d/es-proxy.conf:ro -p 9200:9200 nginx)
    if [[ $? == 0 ]]; then
      echo $cid > $HOME/.run/es-proxy.cid
      sg open all 9200
      echo "Proxying http://${DEV_PREFIX}.dev.rdc.library.northwestern.edu:9200/ to OpenSearch"
      echo "OpenSearch Dashboards available on http://${DEV_PREFIX}.dev.rdc.library.northwestern.edu:9200/_dashboards"
    else
      echo $cid
    fi
  fi
}

stop() {
  if [[ -e $HOME/.run/es-proxy.cid ]]; then
    sg close all 9200
    docker stop $(cat $HOME/.run/es-proxy.cid)
    rm $HOME/.run/es-proxy.cid
  else
    echo "es-proxy not running"
  fi
}

case "$1" in
  start)
    start
    ;;
  stop)
    stop
    ;;
  reset)
    rm -f $HOME/.run/es-proxy.cid
    ;;
esac